<html lang="en" ng-app="travelBlogApp">
<head>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/angular_material/1.1.0/angular-material.min.css">
  <link rel="stylesheet" href="css/styles.css">
 <link rel="stylesheet" href="https://code.getmdl.io/1.1.3/material.blue-light_blue.min.css" /> 
 <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
</head>
<body layout="row" ng-controller="AppCtrl" ng-cloak>
 
 <md-sidenav layout="column" class="md-sidenav-left md-whiteframe-z2" md-component-id="left" md-is-locked-open="$mdMedia('gt-md')">
      <md-toolbar class="md-tall md-hue-2 tb-toolbar-bg">
        <span flex></span>
        <div layout="column" class="md-toolbar-tools-bottom inset tb-toolbar-box">
          <user-avatar></user-avatar>
          <h3>Travel Blog</h3>
          <h4>Pamiętnik podróżnika</h4>
        </div>
      </md-toolbar>
      <md-list>
        
      <md-list-item ng-repeat="item in menu">
       <a ng-href="{{item.link}}" class="tb-sidebar-link" ng-click="closeSidebar()">  
          <md-item-content md-ink-ripple layout="row" layout-align="start center">
            <div class="inset">
              <ng-md-icon icon="{{item.icon}}"></ng-md-icon>
            </div>
            <div class="inset">{{item.title}}
            </div>
          </md-item-content>
        </a>
      </md-list-item>
      <md-divider></md-divider>
      <md-subheader>Tymczasowe</md-subheader>
      <md-list-item ng-repeat="item in temp">
        <a ng-href="{{item.link}}" class="tb-sidebar-link" ng-click="closeSidebar()">
          <md-item-content md-ink-ripple layout="row" layout-align="start center">
            <div class="inset">
              <ng-md-icon icon="{{item.icon}}"></ng-md-icon>
            </div>
            <div class="inset">{{item.title}}
            </div>
          </md-item-content>
        </a>
      </md-list-item>
    </md-list>
  </md-sidenav>
  
  <md-content layout-fill  layout="column"  ng-view></md-content>
        
  <script type="text/javascript" src="https://klaudiusz.eu/wordpress/wp-content/themes/twentysixteen/js/jquery-2.1.1.min.js"></script>
  <script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular.min.js"></script>
  <script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular-sanitize.min.js"></script>
  <script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular-animate.min.js"></script>
  <script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular-aria.min.js"></script>
  <script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular-messages.min.js"></script>
  <script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular-route.js"></script>
  <script src="http://ajax.googleapis.com/ajax/libs/angular_material/1.1.0/angular-material.min.js"></script>
  <script src="http://cdn.jsdelivr.net/angular-material-icons/0.7.0/angular-material-icons.min.js"></script> 
  <script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js"></script>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCkYLhXi73VHa5nABuDwHOE8EBEA8IDnRg"> </script>
  <script type="text/javascript">    
    var app = angular.module("travelBlogApp", ["ngRoute", "ngMaterial", "ngSanitize", "ngMdIcons"]);
    
    app.config(function($routeProvider) {
        $routeProvider
        .when("/", {
            templateUrl : "places.html" 
        })
        .when("/places", {
            templateUrl : "places.html" 
        })
        .when("/place/:id", {
            templateUrl : "place.html",
            controller : "placeCtrl"
        })
        .when("/contact", {
            templateUrl : "contact.html" 
        })
        .when("/notes", {
            templateUrl : "notes.html" 
        })
        .when("/users", {
            templateUrl : "users.html" 
        }); 
    });
  
    app.controller('AppCtrl', ['$scope', '$mdBottomSheet','$mdSidenav', '$mdDialog', function($scope, $mdBottomSheet, $mdSidenav, $mdDialog){
      $scope.toggleSidenav = function(menuId) {
        $mdSidenav(menuId).toggle();
      };

      $scope.closeSidebar = function () {
            $mdSidenav('left').close();

        };
      $scope.menu = [
        {
          link : '#places',
          title: 'Miejsca',
          icon: 'place'
        },
        {
          link : '#users',
          title: 'Osoby',
          icon: 'group'
        },
        {
          link : '#contact',
          title: 'Kontakt',
          icon: 'email'
        }
      ];
      $scope.temp = [
        {
          link : '#notes',
          title: 'Notatki',
          icon: 'note'
        } 
      ];
      
      $scope.alert = '';
      $scope.showListBottomSheet = function($event) {
        $scope.alert = '';
        $mdBottomSheet.show({
          template: '<md-bottom-sheet class="md-list md-has-header"> <h2>Wybierz opcję</h2> <md-list> <md-list-item ng-repeat="item in items"> <div class="inset"><ng-md-icon icon="{{item.icon}}"></ng-md-icon></div><md-item-content md-ink-ripple flex class="inset"> <a flex aria-label="{{item.name}}" ng-click="listItemClick($index)"> <span class="md-inline-list-icon-label">{{ item.name }}</span> </a></md-item-content> </md-list-item> </md-list></md-bottom-sheet>',
          controller: 'ListBottomSheetCtrl',
          targetEvent: $event
        }).then(function(clickedItem) {
          $scope.alert = clickedItem.name + ' clicked!';
        });
      };
      
      

    }]);

    app.controller("placesCtrl", ["$scope", "$http", "$mdBottomSheet", "$mdSidenav", "$mdDialog", function($scope, $http, $mdBottomSheet, $mdSidenav, $mdDialog){
 
      $http.get('http://klaudiusz.eu/wordpress/api/get_recent_posts/').success(function(data) {
               
              }).then(function successCallback(response) {
                      
                      $scope.places = response.data.posts;
                      
                     
                      var mapOptions = {
                            zoom: 6,
                            center: new google.maps.LatLng(51.919438, 19.145136),
                            mapTypeId: google.maps.MapTypeId.TERRAIN
                        }

                        $scope.map = new google.maps.Map(document.getElementById('map'), mapOptions);

                        $scope.markers = [];
                        
                        var infoWindow = new google.maps.InfoWindow();
                        
                        var createMarker = function (info){
                         
                            var marker = new google.maps.Marker({
                                map: $scope.map,
                                position: new google.maps.LatLng(info.custom_fields.lat[0], info.custom_fields.lng[0]),
                                title: info.title,
                                thumbnail: info.thumbnail_images.tb_size.url,
                                id: info.id,
                                date: info.date,
                                excerpt: info.excerpt
                            });

                            marker.content = '<div class="infoWindowContent"><a ng-href="#place/'+info.id+'">zobacz</a></div>';
                            
                            google.maps.event.addListener(marker, 'click', function(){
                                infoWindow.setContent('<h2>' + marker.title + '</h2>' + marker.content);
                                infoWindow.open($scope.map, marker);
                            });

                           
                            $scope.markers.push(marker);
                            
                        }  
                        
                        for (i = 0; i <  response.data.posts.length; i++){
                            createMarker(response.data.posts[i]);
                                                }

                        $scope.openInfoWindow = function(e, selectedMarker){
                   
                            e.preventDefault();
                            google.maps.event.trigger(selectedMarker, 'click');
                        }
 
              }, function errorCallback(response) {
                    console.log('błąd pobierania danych');
              });


              
    }]);
 
   
 
    app.controller("placeCtrl", function ($scope, $http, $routeParams ) {
        $http.get('https://klaudiusz.eu/wordpress/wp-json/wp/v2/posts/' + $routeParams.id).success(function(data) {
          $scope.place = data;
        });
    });
    
    app.controller("contactCtrl", function ($scope) {
        $scope.msg = "Strona kontaktowa";
    });

    app.controller("notesCtrl", function ($scope) {
        $scope.info_box = false;
        var marker_red = 'http://klaudiusz.eu/travelblog/images/marker-r.png';
        var marker_white = 'http://klaudiusz.eu/travelblog/images/marker.png';
        var marker_green = 'http://klaudiusz.eu/travelblog/images/marker-g.png';
        $scope.marker_green = 'http://klaudiusz.eu/travelblog/images/marker-g.png';
        
        $scope.msg = "Notatki";
        $scope.label_id = 0;
        $scope.markers = [];
        $scope.temporary_markers = {};
        $scope.clicked_marker;
        $scope.geocoder = new google.maps.Geocoder();
        $scope.map_notes = new google.maps.Map(document.getElementById('map_notes'), {
                                zoom: 6,
                                center: {lat: 51.919438, lng: 19.145136 },
                                mapTypeControl: true,
                                mapTypeControlOptions: {
                                    style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
                                    position: google.maps.ControlPosition.TOP_CENTER
                                },
                                zoomControl: true,
                                zoomControlOptions: {
                                    position: google.maps.ControlPosition.RIGHT_CENTER
                                },
                                scaleControl: true,
                                streetViewControl: true,
                                streetViewControlOptions: {
                                    position: google.maps.ControlPosition.LEFT_TOP
                                },
                                fullscreenControl: true
        });

        $scope.infowindow = new google.maps.InfoWindow({
                content: null
             });

        $scope.geoJson = {
                          "type": "FeatureCollection",
                          "features": []
                          };

        $scope.marker_info = {
                          "id": "",
                          "name": "",
                          "description": ""
                           };
         
        function newMarker(position) {
            clearInfoBox();
            if ($scope.infowindow) { $scope.infowindow.close(); };
            //var token = Math.random().toString(36).substr(2, 5) + new Date().getTime();
            var token = new Date().getTime() + Math.random().toString(36).substr(2, 5);
            $scope.label_id++; 
       
            var label_id = $scope.label_id.toString(); 
            var marker = new google.maps.Marker({
                                                  position: position, 
                                                  map: $scope.map_notes, 
                                                  draggable: true, 
                                                  id: token, 
                                                  feature: {
                                                        "type": "Feature",
                                                        "geometry": {
                                                                      "type": "Point",
                                                                      "coordinates": [position.lat(), position.lng()]
                                                              },
                                                        "properties": {
                                                                "id": token,
                                                                "name": $scope.marker_info.name,
                                                                "description": $scope.marker_info.description
                                                                }
                                                  }, 
                                                  label: label_id,
                                                  icon: marker_green
                                                });
         
            //ZMIANA KOLORU MARKERA
            if($scope.markers.length != 0){
                for (var i = 0; i < $scope.markers.length; i++) {                  
                     $scope.markers[i].setIcon(marker_white)
                }
             };

            //NOWY MARKER - PRZEŁADOWANIE TABLICY Z MARKERAMI 
            $scope.markers = [];
            $scope.temporary_markers[token] = marker;
          
         
                for(let x of Object.keys($scope.temporary_markers).sort()){
                    
                  
                    $scope.markers.push($scope.temporary_markers[x]);
                     
                      
                   
                }
              
                  
            //KLIK MARKERA       
            marker.addListener('click', function() {
      
              
                  if ($scope.infowindow) { $scope.infowindow.close(); }
                  $scope.clicked_marker = marker;
                  $scope.$apply(function() {   $scope.info_box = true;    });
                  $scope.infowindow.setContent("<h3>"+ marker.feature.properties.name + "</h3><p>" + marker.feature.properties.description + "</p>");
                   
                  //OTWIERA INFOWINDOW  
                  if(marker.feature.properties.name != "") {
                      for (var i = 0; i < $scope.markers.length; i++) {
                        if ($scope.markers[i].id == marker.id) {
                                  $scope.infowindow.open($scope.map_notes, $scope.markers[i]);
                        }
                      }  
                  }
                    
                  //ZMIANA KOLORU MARKERA
                  if($scope.markers.length != 0){
                      for (var i = 0; i < $scope.markers.length; i++) {                  
                           $scope.markers[i].setIcon(marker_white)
                      }
                  }; 
                  marker.setIcon(marker_red);    

            
                
            });

            //RIGHTCLICK USUNIECIE MARKERA 
            marker.addListener('rightclick', function() {
                delMarker(marker);
            });
            
            // PRZESUNIĘCIE MARKERA                   
            marker.addListener('dragend', function() {
               marker.addListener('dragstart', function() { var position = marker.getPosition();});
                if($scope.clicked_marker){
                   if(marker.id == $scope.clicked_marker.id){
                       $scope.clicked_marker.feature.geometry.coordinates[0] = marker.position.lat();
                       $scope.clicked_marker.feature.geometry.coordinates[1] = marker.position.lng();
                         
                       $scope.markers = [];
                       var upd_marker_id = $scope.clicked_marker.id;
                   
                       delete $scope.temporary_markers[ upd_marker_id ];
               
                       $scope.temporary_markers[ upd_marker_id] = $scope.clicked_marker;
                    
                       for(let x of Object.keys($scope.temporary_markers).sort()){

                          $scope.markers.push($scope.temporary_markers[x]);
                       
                        }

                    } else {
                        alert('musisz zaznaczyć marker');
                        marker.setPosition(position);
                        
                    }
                } else {
                  alert('musisz zaznaczyć marker');
                  marker.setPosition(position);
              
                }
            });     


        }  // KONIEC NEWMAKER

        // UPDATE MARKERA
                        
        google.maps.event.addDomListener(document.getElementById('ok'), 'click', function() {

                $scope.markers = [];
                var upd_marker_id = $scope.clicked_marker.id;
               
                delete $scope.temporary_markers[ upd_marker_id ];

                $scope.clicked_marker.feature.properties.name = $scope.marker_info.name;
                $scope.clicked_marker.feature.properties.description = $scope.marker_info.description;            
                $scope.temporary_markers[ upd_marker_id] = $scope.clicked_marker;

                
                for(let x of Object.keys($scope.temporary_markers).sort()){
                 
                 
                    $scope.markers.push($scope.temporary_markers[x]);
                   
                }

                $scope.infowindow.setContent("<h3>"+ $scope.marker_info.name + "</h3><p>" + $scope.marker_info.description + "</p>");
               
               

                 //OTWIERA INFOWINDOW  
                  if( $scope.clicked_marker.name != "") {
                      for (var i = 0; i < $scope.markers.length; i++) {
                        if ($scope.markers[i].id ==  $scope.clicked_marker.id) {
                                  $scope.infowindow.close($scope.map_notes, $scope.markers[i]);
                                  $scope.infowindow.open($scope.map_notes, $scope.markers[i]);
                        }
                      }  
                  }


                  
                $scope.$apply(function() {
                    $scope.info_box = false;     
                });
          });   


          google.maps.event.addDomListener(document.getElementById('submit'), 'click', function() {
              geocodeAddress( $scope.geocoder, $scope.map_notes);
          });
                

          google.maps.event.addListener($scope.map_notes, 'rightclick', function(event) {  
              newMarker(event.latLng);              
          });
          
          google.maps.event.addDomListener(document.getElementById('save'), 'click', function() {
               // console.log(JSON.stringify($scope.geoJson));
              google.maps.Data.toGeoJson(function(data){console.log(data)});
              
          });
                
          google.maps.event.addDomListener(document.getElementById('del'), 'click', function() { 
           
             delMarker();
          });

        function delMarker(marker) {

            if (marker != null) {
             var del_marker_id = marker.id;
               marker.setMap(null); 
            } else {
               var del_marker_id = $scope.clicked_marker.id;
                $scope.clicked_marker.setMap(null); 
            }    
              
            $scope.markers = []; 
                
            delete $scope.temporary_markers[del_marker_id]; 
             
            for(let x of Object.keys($scope.temporary_markers).sort()){
                    
                $scope.markers.push($scope.temporary_markers[x]);
                            
            }
            
            $scope.label_id = 1;
                  
            for(var i = 0; i < $scope.markers.length; i++) {
                var x = $scope.label_id++; 
                    x = x.toString();
                    $scope.markers[i].setLabel(x);
            }
            
            $scope.label_id = $scope.label_id -1;
        }

        function geocodeAddress(geocoder, resultsMap) {
            var address = document.getElementById('address').value;
            geocoder.geocode({'address': address}, function(results, status) {
              if (status === 'OK') {
                                       
                $scope.map_notes.setCenter(results[0].geometry.location);
                 
                  newMarker(results[0].geometry.location);

              } else {
                alert('Coś poszło nie tak: ' + status);
              }
            });
        }

        function clearInfoBox() {
          $scope.$apply(function() {
                 $scope.marker_info.id = '';
                 $scope.marker_info.name = '';
                 $scope.marker_info.description = '';
                 $scope.info_box = false;
               });
        }

    });

    app.controller("usersCtrl", function ($scope) {
        $scope.msg = "Osoby";
    });

    app.controller('ListBottomSheetCtrl', function($scope, $mdBottomSheet) {
      $scope.items = [
        { name: 'Udostępnij notatki', icon: 'share' },   
        { name: 'Pobierz notatki', icon: 'picture_as_pdf' },
      ];
      
      $scope.listItemClick = function($index) {
        var clickedItem = $scope.items[$index];
        $mdBottomSheet.hide(clickedItem);
      };
    });

    app.config(function($mdThemingProvider) {
      var customBlueMap =     $mdThemingProvider.extendPalette('light-blue', {
        'contrastDefaultColor': 'light',
        'contrastDarkColors': ['50'],
        '50': 'ffffff'
      });
      $mdThemingProvider.definePalette('customBlue', customBlueMap);
      $mdThemingProvider.theme('default')
        .primaryPalette('customBlue', {
          'default': '500',
          'hue-1': '50'
        })
        .accentPalette('pink');
      $mdThemingProvider.theme('input', 'default')
            .primaryPalette('grey')
    }); 

    function DialogController($scope, $mdDialog) {
      $scope.hide = function() {
        $mdDialog.hide();
      };
      $scope.cancel = function() {
        $mdDialog.cancel();
      };
      $scope.answer = function(answer) {
        $mdDialog.hide(answer);
      };
    };

    app.directive('userAvatar', function() {
      return {
        replace: true,
        template: '<img width="70" ng-src="images/klaudiusz.jpg" alt="klaudiusz" class="user-avatar">'
      };
    });
  </script>
  
   
</body>
</html>